!function(e){const t=class{constructor(){this._cfg=e._sec||{},this._proc=!1,this._bills=[],this.init()}init(){this._loadApiKey(),this._loadBills(),this._setupEvents(),this._setupTabs(),this._checkConfig()}_setupTabs(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-panel");e.forEach(n=>{n.addEventListener("click",()=>{const o=n.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),n.classList.add("active"),document.getElementById(o).classList.add("active")})})}_setupEvents(){document.getElementById("guardarApiKey").addEventListener("click",()=>{this._saveApiKey()});const e=document.getElementById("uploadArea"),t=document.getElementById("fileInput");e.addEventListener("click",()=>{t.click()}),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",e=>{e.preventDefault(),this._element.classList.remove("dragover");const n=e.dataTransfer.files;this._processFiles(n)}),t.addEventListener("change",e=>{this._processFiles(e.target.files)}),document.getElementById("editarDatos").addEventListener("click",()=>{this._enableEdit()}),document.getElementById("confirmarTransaccion").addEventListener("click",()=>{this._confirmTransaction()}),document.getElementById("descartarDatos").addEventListener("click",()=>{this._discardData()})}_loadApiKey(){const t=this._cfg.getKey?this._cfg.getKey():localStorage.getItem("_cfg");if(t){const n=this._cfg.decrypt?this._cfg.decrypt(t):t;n&&(this._apiKey=n,document.getElementById("chatgptApiKey").value="*".repeat(20))}}_saveApiKey(){const t=document.getElementById("chatgptApiKey").value.trim();if(!t)return void alert("Por favor, ingresa tu API Key de OpenAI");if(!this._cfg.isValid||!this._cfg.isValid(t))return void alert("La API Key debe comenzar con sk-");this._apiKey=t,this._cfg.setKey?this._cfg.setKey(t):localStorage.setItem("_cfg",t),this._checkConfig(),e.gestorFinanzas&&e.gestorFinanzas.mostrarAlerta("API Key guardada correctamente","success")}_checkConfig(){const e=document.getElementById("apiConfig"),t=document.getElementById("uploadSection");this._apiKey?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none")}async _processFiles(e){if(!this._apiKey)return void alert("Primero configura tu API Key de OpenAI");if(this._proc)return void alert("Ya hay un archivo siendo procesado. Espera a que termine.");for(let t of e)this._validateFile(t)&&await this._processFile(t)}_validateFile(e){const t=["image/jpeg","image/jpg","image/png","application/pdf"];return!t.includes(e.type)?(alert("Tipo de archivo no soportado. Usa JPG, PNG o PDF."),!1):!(e.size>10485760)||(alert("El archivo es demasiado grande. Máximo 10MB."),!1)}async _processFile(e){this._proc=!0,this._showProcessing(!0);try{const t=await this._fileToBase64(e);this._updateProgress(30,"Enviando a ChatGPT...");const n=await this._extractWithChatGPT(t,e.type);this._updateProgress(80,"Procesando respuesta...");const o={id:this._generateId(),nombre:e.name,tipo:e.type,tamaño:e.size,fechaProcesado:(new Date).toISOString(),datos:n,miniatura:t};this._bills.push(o),this._saveBills(),this._showExtractedData(n),this._updateProgress(100,"Completado"),setTimeout(()=>{this._showProcessing(!1)},1e3)}catch(t){console.error("Error procesando archivo:",t),e.gestorFinanzas&&e.gestorFinanzas.mostrarAlerta("Error al procesar el archivo: "+t.message,"error"),this._showProcessing(!1)}finally{this._proc=!1}}async _fileToBase64(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=()=>t(o.result),o.onerror=n,o.readAsDataURL(e)})}async _extractWithChatGPT(e,t){const n={model:"gpt-4o-mini",messages:[{role:"user",content:[{type:"text",text:'Analiza esta imagen de factura o recibo y extrae la siguiente información en formato JSON:\n\n{\n    "descripcion": "descripción del establecimiento o producto/servicio",\n    "monto": "monto total numérico (solo números, sin símbolos)",\n    "fecha": "fecha en formato YYYY-MM-DD",\n    "categoria": "una de estas: alimentacion, transporte, vivienda, servicios, salud, entretenimiento, ropa, educacion, otros",\n    "tipo": "gasto o ingreso (la mayoría son gastos)",\n    "establecimiento": "nombre del establecimiento",\n    "detalles": "productos o servicios detallados si están disponibles"\n}\n\nSi no puedes extraer algún dato, usa null. Para la categoría, elige la más apropiada basándose en el tipo de establecimiento o productos.'},{type:"image_url",image_url:{url:e}}]}],max_tokens:500,temperature:.1},o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._apiKey}`},body:JSON.stringify(n)});if(!o.ok){const e=await o.json();throw new Error(`Error de API: ${e.error?.message||"Error desconocido"}`)}const s=await o.json(),i=s.choices[0].message.content;try{const e=i.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0]);throw new Error("No se pudo extraer JSON de la respuesta")}catch(e){throw console.error("Error parseando JSON:",i),new Error("Error interpretando la respuesta de ChatGPT")}}_showProcessing(e){document.getElementById("processingStatus").style.display=e?"block":"none",e||this._updateProgress(0,"Analizando imagen con ChatGPT...")}_updateProgress(e,t){document.getElementById("progressFill").style.width=`${e}%`,document.getElementById("statusMessage").textContent=t}_showExtractedData(e){document.getElementById("extractedDesc").value=e.descripcion||"",document.getElementById("extractedAmount").value=e.monto||"",document.getElementById("extractedDate").value=e.fecha||"",document.getElementById("extractedCategory").value=e.categoria||"otros",document.getElementById("extractedType").value=e.tipo||"gasto",this._disableEdit(),document.getElementById("extractedData").style.display="block"}_enableEdit(){["extractedDesc","extractedAmount","extractedDate"].forEach(e=>{document.getElementById(e).removeAttribute("readonly")}),document.getElementById("editarDatos").textContent="Edición Habilitada",document.getElementById("editarDatos").disabled=!0}_disableEdit(){["extractedDesc","extractedAmount","extractedDate"].forEach(e=>{document.getElementById(e).setAttribute("readonly",!0)}),document.getElementById("editarDatos").textContent="Editar",document.getElementById("editarDatos").disabled=!1}_confirmTransaction(){const t=document.getElementById("extractedDesc").value.trim(),n=parseFloat(document.getElementById("extractedAmount").value),o=document.getElementById("extractedDate").value,s=document.getElementById("extractedCategory").value,i=document.getElementById("extractedType").value;if(!t||!n||!o||!s)return void alert("Por favor, completa todos los campos obligatorios");if(n<=0)return void alert("El monto debe ser mayor a 0");const a={id:this._generateId(),descripcion:t,monto:n,fecha:o,categoria:s,tipo:i,fechaCreacion:(new Date).toISOString(),origen:"factura"};"ingreso"===i?(e.gestorFinanzas.ingresos.push(a),e.gestorFinanzas.renderizarIngresos()):(e.gestorFinanzas.gastos.push(a),e.gestorFinanzas.renderizarGastos()),e.gestorFinanzas.guardarDatos(),e.gestorFinanzas.actualizarBalance(),e.gestorFinanzas.mostrarAlerta(`${"ingreso"===i?"Ingreso":"Gasto"} agregado exitosamente`,"success"),this._discardData(),this._renderBills()}_discardData(){document.getElementById("extractedData").style.display="none",["extractedDesc","extractedAmount","extractedDate"].forEach(e=>{document.getElementById(e).value=""}),document.getElementById("extractedCategory").value="otros",document.getElementById("extractedType").value="gasto"}_loadBills(){try{const e=localStorage.getItem("gestorFinanzas_facturas");e&&(this._bills=JSON.parse(e)),this._renderBills()}catch(e){console.error("Error al cargar facturas:",e)}}_saveBills(){try{localStorage.setItem("gestorFinanzas_facturas",JSON.stringify(this._bills))}catch(e){console.error("Error al guardar facturas:",e)}}_renderBills(){const e=document.getElementById("facturasList");if(e.innerHTML="",0===this._bills.length)return void(e.innerHTML='<div class="empty-message"><p>No hay facturas procesadas aún.</p></div>');this._bills.sort((e,t)=>new Date(t.fechaProcesado)-new Date(e.fechaProcesado)).forEach(t=>{const n=this._createBillElement(t);e.appendChild(n)})}_createBillElement(e){const t=document.createElement("div");t.className="factura-item";const n=e.tipo.startsWith("image/"),o=n?`<img src="${e.miniatura}" alt="Factura">`:'<i class="fas fa-file-pdf"></i>';return t.innerHTML=`\n            <div class="factura-thumbnail">\n                ${o}\n            </div>\n            <div class="factura-info">\n                <h4>${e.datos.descripcion||e.nombre}</h4>\n                <div class="factura-details">\n                    <span><i class="fas fa-calendar"></i> ${this._formatDate(e.datos.fecha)}</span>\n                    <span><i class="fas fa-tag"></i> ${this._getCategoryName(e.datos.categoria)}</span>\n                    <span><i class="fas fa-file"></i> ${e.nombre}</span>\n                </div>\n            </div>\n            <div class="factura-amount ${e.datos.tipo}">\n                ${this._formatCurrency(e.datos.monto)}\n            </div>\n        `,t}_generateId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}_formatCurrency(e){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(e||0)}_formatDate(e){return e?new Date(e+"T00:00:00").toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric"}):"N/A"}_getCategoryName(e){const t={alimentacion:"Alimentación",transporte:"Transporte",vivienda:"Vivienda",servicios:"Servicios",salud:"Salud",entretenimiento:"Entretenimiento",ropa:"Ropa",educacion:"Educación",otros:"Otros"};return t[e]||e}};e.GestorFacturas=t}(window);